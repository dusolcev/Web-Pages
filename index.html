<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Pages Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow-x: hidden; overflow-y: visible !important; }
        .card:hover .actions { opacity: 1; }
        .actions { opacity: 0; transition: opacity 0.2s; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">

    <!-- Header -->
    <header class="bg-white border-b border-slate-200 sticky top-0 z-30">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center gap-2">
                    <div class="bg-indigo-600 p-2 rounded-lg text-white">
                        <i class="fa-solid fa-layer-group"></i>
                    </div>
                    <h1 class="text-xl font-bold text-slate-800 tracking-tight">Pages<span class="text-indigo-600">Hub</span></h1>
                </div>
                <div class="flex items-center gap-3">
                    <div id="authContainer"></div>
                    <div id="loginModal" class="modal fixed inset-0 z-[60] opacity-0 pointer-events-none flex items-center justify-center p-4">
                        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm"></div>
                        <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm relative z-10 overflow-hidden p-8 text-center">
                            <div class="w-16 h-16 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                                <i class="fa-brands fa-github"></i>
                            </div>
                            <h3 class="text-xl font-bold mb-2">Device Authorization</h3>
                            <p class="text-slate-500 text-sm mb-6">Enter the code below on GitHub to log in.</p>
                            <div id="deviceCodeDisplay" class="bg-slate-100 rounded-xl py-4 px-6 text-3xl font-mono font-bold tracking-widest text-indigo-600 mb-6">
                                -----
                            </div>
                            <a id="deviceAuthLink" href="#" target="_blank" class="block w-full bg-indigo-600 text-white py-3 rounded-lg text-sm font-bold hover:bg-indigo-700 transition-all mb-4">
                                Open GitHub Login
                            </a>
                            <p class="text-[10px] text-slate-400 uppercase font-bold tracking-widest animate-pulse" id="pollingStatus">
                                Waiting for authorization...
                            </p>
                            <button onclick="toggleModal('loginModal', false)" class="mt-6 text-xs text-slate-400 hover:text-slate-600 font-medium underline">Cancel</button>
                        </div>
                    </div>
                    <button id="addPageBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors flex items-center gap-2" style="display: none;">
                        <i class="fa-solid fa-plus text-xs"></i> New Page
                    </button>
                    <button id="settingsBtn" class="text-slate-500 hover:text-slate-800 p-2 transition-colors">
                        <i class="fa-solid fa-cog text-lg"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Search and Filter -->
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
            <div class="relative flex-1 max-w-md">
                <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm"></i>
                <input type="text" id="searchInput" placeholder="Search pages..." class="w-full bg-white border border-slate-200 rounded-xl py-2.5 pl-10 pr-4 text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
            </div>
            <div id="categoryFilters" class="flex items-center gap-2 overflow-x-auto pb-2 md:pb-0 no-scrollbar">
                <button class="cat-filter active bg-indigo-100 text-indigo-700 px-4 py-2 rounded-full text-xs font-bold uppercase tracking-wider whitespace-nowrap" data-category="all">All</button>
                <!-- Dynamic categories -->
            </div>
        </div>

        <!-- Grid -->
        <div id="pagesGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <!-- Loading skeleton -->
            <div class="animate-pulse bg-white rounded-2xl border border-slate-200 p-6 h-48"></div>
            <div class="animate-pulse bg-white rounded-2xl border border-slate-200 p-6 h-48"></div>
            <div class="animate-pulse bg-white rounded-2xl border border-slate-200 p-6 h-48"></div>
        </div>
    </main>

    <!-- Modals -->
    <!-- Settings Modal -->
    <div id="settingsModal" class="modal fixed inset-0 z-50 opacity-0 pointer-events-none flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm"></div>
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md relative z-10 overflow-hidden">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                <h3 class="text-lg font-bold">Settings</h3>
                <button class="closeModal text-slate-400 hover:text-slate-600"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-1.5">GitHub Username (Owner)</label>
                    <input type="text" id="ghUsername" class="w-full bg-slate-50 border border-slate-200 rounded-lg py-2 px-3 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-1.5">Repository Name</label>
                    <input type="text" id="ghRepo" class="w-full bg-slate-50 border border-slate-200 rounded-lg py-2 px-3 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                <div class="border-t border-slate-100 pt-4">
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-1.5">GitHub OAuth Client ID</label>
                    <input type="text" id="ghClientId" placeholder="Ov23..." class="w-full bg-slate-50 border border-slate-200 rounded-lg py-2 px-3 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
            </div>
            <div class="p-6 bg-slate-50 flex justify-end">
                <button id="saveSettings" class="bg-indigo-600 text-white px-6 py-2 rounded-lg text-sm font-bold shadow-md shadow-indigo-200 hover:bg-indigo-700 transition-all">Save Config</button>
            </div>
        </div>
    </div>

    <!-- Page Modal (Add/Edit) -->
    <div id="pageModal" class="modal fixed inset-0 z-50 opacity-0 pointer-events-none flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm"></div>
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-4xl relative z-10 flex flex-col max-h-[90vh]">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                <h3 id="modalTitle" class="text-lg font-bold">New Page</h3>
                <button class="closeModal text-slate-400 hover:text-slate-600"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="p-6 overflow-y-auto space-y-6 flex-1">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="md:col-span-2">
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-1.5">Page Title</label>
                        <input type="text" id="pageTitle" placeholder="e.g. Q4 Financial Report" class="w-full bg-slate-50 border border-slate-200 rounded-lg py-2.5 px-3 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-1.5">Category</label>
                        <input type="text" id="pageCategory" placeholder="e.g. Finance" class="w-full bg-slate-50 border border-slate-200 rounded-lg py-2.5 px-3 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-1.5">Filename</label>
                    <input type="text" id="pageFilename" placeholder="report.html" class="w-full bg-slate-50 border border-slate-200 rounded-lg py-2.5 px-3 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                <div class="flex-1 flex flex-col">
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-1.5">HTML Content</label>
                    <textarea id="pageHtml" class="flex-1 min-h-[300px] w-full bg-slate-900 text-emerald-400 font-mono text-xs p-4 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none resize-none"></textarea>
                </div>
            </div>
            <div class="p-6 bg-slate-50 border-t border-slate-100 flex justify-between items-center">
                <div id="statusMsg" class="text-xs font-medium"></div>
                <button id="savePageBtn" class="bg-indigo-600 text-white px-8 py-2.5 rounded-lg text-sm font-bold shadow-md shadow-indigo-200 hover:bg-indigo-700 transition-all flex items-center gap-2">
                    <i class="fa-solid fa-save"></i> Save Page
                </button>
            </div>
        </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div id="deleteModal" class="modal fixed inset-0 z-50 opacity-0 pointer-events-none flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm"></div>
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm relative z-10 overflow-hidden">
            <div class="p-8 text-center">
                <div class="w-16 h-16 bg-rose-100 text-rose-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                    <i class="fa-solid fa-triangle-exclamation"></i>
                </div>
                <h3 class="text-xl font-bold mb-2">Are you sure?</h3>
                <p class="text-slate-500 text-sm">This will permanently delete the file and all its data from the repository.</p>
            </div>
            <div class="p-4 bg-slate-50 flex gap-3">
                <button class="closeModal flex-1 bg-white border border-slate-200 py-2 rounded-lg text-sm font-bold hover:bg-slate-100 transition-all">Cancel</button>
                <button id="confirmDeleteBtn" class="flex-1 bg-rose-600 text-white py-2 rounded-lg text-sm font-bold hover:bg-rose-700 transition-all shadow-md shadow-rose-200">Delete</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG & STATE ---
        let config = {
            username: localStorage.getItem('ghUsername') || 'dusolcev',
            repo: localStorage.getItem('ghRepo') || 'Web-Pages',
            token: localStorage.getItem('ghToken') || '',
            clientId: localStorage.getItem('ghClientId') || ''
        };

        let pages = [];
        let user = null;
        let currentEditingFile = null;
        let fileToDelete = null;

        // --- DOM ELEMENTS ---
        const pagesGrid = document.getElementById('pagesGrid');
        const categoryFilters = document.getElementById('categoryFilters');
        const searchInput = document.getElementById('searchInput');

        // --- GITHUB API HELPERS ---
        async function ghFetch(path, options = {}) {
            const url = `https://api.github.com/repos/${config.username}/${config.repo}/contents/${path}`;
            const headers = {
                'Accept': 'application/vnd.github+json',
                ...(config.token && { 'Authorization': `Bearer ${config.token}` }),
                ...options.headers
            };
            const response = await fetch(url, { ...options, headers });
            if (!response.ok && response.status !== 404) {
                const err = await response.json();
                throw new Error(err.message || 'GitHub API error');
            }
            return response;
        }

        async function getFile(path) {
            const res = await ghFetch(path);
            if (res.status === 404) return null;
            const data = await res.json();
            return {
                sha: data.sha,
                content: decodeURIComponent(escape(atob(data.content))) // Handle UTF-8
            };
        }

        async function saveFile(path, content, message, sha = null) {
            const res = await ghFetch(path, {
                method: 'PUT',
                body: JSON.stringify({
                    message,
                    content: btoa(unescape(encodeURIComponent(content))),
                    sha
                })
            });
            return await res.json();
        }

        async function deleteFile(path, sha, message) {
            const res = await ghFetch(path, {
                method: 'DELETE',
                body: JSON.stringify({ message, sha })
            });
            return await res.json();
        }

        // --- AUTH LOGIC ---
        let pollingInterval = null;
        const CORS_PROXY = "https://corsproxy.io/?";

        async function login() {
            if (!config.clientId) {
                alert("Please configure GitHub Client ID in Settings first.");
                toggleModal('settingsModal', true);
                return;
            }

            try {
                const response = await fetch(`${CORS_PROXY}https://github.com/login/device/code`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        client_id: config.clientId,
                        scope: 'repo'
                    })
                });

                const data = await response.json();
                if (data.user_code) {
                    document.getElementById('deviceCodeDisplay').innerText = data.user_code;
                    document.getElementById('deviceAuthLink').href = data.verification_uri;
                    toggleModal('loginModal', true);
                    startPolling(data.device_code, data.interval || 5);
                } else {
                    alert("Failed to start login: " + (data.error_description || data.error || "Unknown error"));
                }
            } catch (error) {
                alert("Error starting login. Ensure 'Device Flow' is enabled in your GitHub OAuth App settings.\nError: " + error.message);
            }
        }

        function startPolling(deviceCode, interval) {
            if (pollingInterval) clearInterval(pollingInterval);
            pollingInterval = setInterval(async () => {
                try {
                    const response = await fetch(`${CORS_PROXY}https://github.com/login/oauth/access_token`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({
                            client_id: config.clientId,
                            device_code: deviceCode,
                            grant_type: 'urn:ietf:params:oauth:grant-type:device_code'
                        })
                    });

                    const data = await response.json();
                    if (data.access_token) {
                        clearInterval(pollingInterval);
                        config.token = data.access_token;
                        localStorage.setItem('ghToken', config.token);
                        toggleModal('loginModal', false);
                        await checkAuth();
                    } else if (data.error === 'authorization_pending') {
                        // Keep polling
                    } else {
                        clearInterval(pollingInterval);
                        if (data.error !== 'expired_token') {
                            alert("Login failed: " + (data.error_description || data.error));
                        }
                        toggleModal('loginModal', false);
                    }
                } catch (error) {
                    console.error("Polling error:", error);
                }
            }, interval * 1000);
        }

        function logout() {
            config.token = '';
            user = null;
            localStorage.removeItem('ghToken');
            if (pollingInterval) clearInterval(pollingInterval);
            updateAuthUI();
        }

        async function checkAuth() {
            if (config.token) {
                try {
                    const res = await fetch('https://api.github.com/user', {
                        headers: { 'Authorization': `Bearer ${config.token}` }
                    });
                    if (res.ok) {
                        user = await res.json();
                        await checkPermissions();
                    } else {
                        logout();
                    }
                } catch (e) {
                    console.error("Auth check failed", e);
                }
            }
            updateAuthUI();
        }

        async function checkPermissions() {
            try {
                const res = await fetch(`https://api.github.com/repos/${config.username}/${config.repo}`, {
                    headers: { 'Authorization': `Bearer ${config.token}` }
                });
                if (res.ok) {
                    const repoData = await res.json();
                    user.canPush = repoData.permissions && repoData.permissions.push;
                } else {
                    user.canPush = false;
                }
            } catch (e) {
                user.canPush = false;
            }
        }

        function updateAuthUI() {
            const authContainer = document.getElementById('authContainer');
            if (user) {
                authContainer.innerHTML = `
                    <div class="flex items-center gap-2">
                        <img src="${user.avatar_url}" class="w-8 h-8 rounded-full border border-slate-200" alt="${user.login}">
                        <div class="hidden sm:block">
                            <p class="text-[10px] font-bold text-slate-400 uppercase leading-none">${user.canPush ? 'Admin' : 'Viewer'}</p>
                            <p class="text-xs font-semibold text-slate-700">${user.login}</p>
                        </div>
                        <button onclick="logout()" class="text-slate-400 hover:text-rose-600 p-2 transition-colors" title="Logout">
                            <i class="fa-solid fa-sign-out-alt"></i>
                        </button>
                    </div>
                `;
                document.getElementById('addPageBtn').style.display = user.canPush ? 'flex' : 'none';
            } else {
                authContainer.innerHTML = `
                    <button onclick="login()" class="bg-slate-800 hover:bg-slate-900 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors flex items-center gap-2">
                        <i class="fa-brands fa-github text-base"></i> Login
                    </button>
                `;
                document.getElementById('addPageBtn').style.display = 'none';
            }
            renderPages();
        }

        // --- CORE LOGIC ---
        async function loadPages() {
            try {
                const res = await getFile('metadata.json');
                pages = res ? JSON.parse(res.content) : [];
                renderPages();
                renderFilters();
            } catch (error) {
                console.error(error);
                pagesGrid.innerHTML = `<div class="col-span-full p-12 text-center bg-rose-50 rounded-2xl border border-rose-100 text-rose-600 font-medium">Error loading pages: ${error.message}</div>`;
            }
        }

        function renderPages(filter = 'all', search = '') {
            const filtered = pages.filter(p => {
                const matchesCat = filter === 'all' || p.category === filter;
                const matchesSearch = p.title.toLowerCase().includes(search.toLowerCase()) ||
                                    p.filename.toLowerCase().includes(search.toLowerCase());
                return matchesCat && matchesSearch;
            });

            if (filtered.length === 0) {
                pagesGrid.innerHTML = `<div class="col-span-full p-20 text-center text-slate-400">
                    <i class="fa-solid fa-folder-open text-4xl mb-4 block"></i>
                    No pages found matching your criteria.
                </div>`;
                return;
            }

            pagesGrid.innerHTML = filtered.map(p => `
                <div class="card bg-white rounded-2xl border border-slate-200 overflow-hidden hover:shadow-xl hover:border-indigo-200 transition-all group relative">
                    <div class="p-6">
                        <div class="flex items-start justify-between mb-4">
                            <span class="bg-indigo-50 text-indigo-600 text-[10px] font-black uppercase tracking-widest px-2 py-1 rounded">
                                ${p.category}
                            </span>
                            <div class="actions flex gap-1 ${user && user.canPush ? '' : 'hidden'}">
                                <button onclick="editPage('${p.filename}')" class="w-8 h-8 rounded-full bg-slate-50 text-slate-400 hover:bg-indigo-50 hover:text-indigo-600 transition-all flex items-center justify-center">
                                    <i class="fa-solid fa-pen text-xs"></i>
                                </button>
                                <button onclick="promptDelete('${p.filename}')" class="w-8 h-8 rounded-full bg-slate-50 text-slate-400 hover:bg-rose-50 hover:text-rose-600 transition-all flex items-center justify-center">
                                    <i class="fa-solid fa-trash text-xs"></i>
                                </button>
                            </div>
                        </div>
                        <h3 class="font-bold text-slate-800 mb-1 leading-snug group-hover:text-indigo-600 transition-colors">
                            <a href="${p.filename}" target="_blank">${p.title}</a>
                        </h3>
                        <p class="text-xs text-slate-400 font-medium mb-4">${p.filename}</p>
                        <div class="flex items-center justify-between mt-auto pt-4 border-t border-slate-50">
                            <span class="text-[10px] font-bold text-slate-300 uppercase tracking-tighter">
                                <i class="fa-regular fa-calendar mr-1"></i> ${p.date}
                            </span>
                            <a href="${p.filename}" target="_blank" class="text-xs font-bold text-indigo-600 flex items-center gap-1 hover:gap-2 transition-all">
                                View <i class="fa-solid fa-arrow-right text-[10px]"></i>
                            </a>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderFilters() {
            const categories = ['all', ...new Set(pages.map(p => p.category))];
            categoryFilters.innerHTML = categories.map(cat => `
                <button class="cat-filter ${cat === 'all' ? 'active bg-indigo-100 text-indigo-700' : 'bg-white text-slate-500 border border-slate-200'} px-4 py-2 rounded-full text-xs font-bold uppercase tracking-wider whitespace-nowrap transition-all hover:border-indigo-300"
                        data-category="${cat}">
                    ${cat}
                </button>
            `).join('');

            document.querySelectorAll('.cat-filter').forEach(btn => {
                btn.onclick = () => {
                    document.querySelectorAll('.cat-filter').forEach(b => {
                        b.classList.remove('active', 'bg-indigo-100', 'text-indigo-700');
                        b.classList.add('bg-white', 'text-slate-500', 'border', 'border-slate-200');
                    });
                    btn.classList.add('active', 'bg-indigo-100', 'text-indigo-700');
                    btn.classList.remove('bg-white', 'text-slate-500', 'border');
                    renderPages(btn.dataset.category, searchInput.value);
                };
            });
        }

        // --- ACTIONS ---
        function injectHomeButton(html) {
            const homeBtn = `
    <!-- Floating Home Button -->
    <a href="index.html" style="position:fixed;bottom:20px;right:20px;background:#4f46e5;color:#fff;width:50px;height:50px;border-radius:50%;display:flex;align-items:center;justify-content:center;text-decoration:none;z-index:9999;box-shadow:0 4px 12px rgba(79,70,229,0.4);transition:transform 0.2s ease-in-out;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
    </a>`;
            if (html.includes('index.html')) return html; // Avoid double injection
            if (html.includes('</body>')) {
                return html.replace('</body>', homeBtn + '</body>');
            }
            return html + homeBtn;
        }

        async function editPage(filename) {
            const page = pages.find(p => p.filename === filename);
            if (!page) return;

            currentEditingFile = page;
            document.getElementById('modalTitle').innerText = 'Edit Page';
            document.getElementById('pageTitle').value = page.title;
            document.getElementById('pageCategory').value = page.category;
            document.getElementById('pageFilename').value = page.filename;
            document.getElementById('pageFilename').disabled = true;

            toggleModal('pageModal', true);
            document.getElementById('pageHtml').value = 'Loading content...';

            try {
                const res = await getFile(filename);
                document.getElementById('pageHtml').value = res.content;
            } catch (error) {
                document.getElementById('pageHtml').value = 'Error loading content: ' + error.message;
            }
        }

        function promptDelete(filename) {
            fileToDelete = filename;
            toggleModal('deleteModal', true);
        }

        // --- MODAL HELPERS ---
        function toggleModal(id, show) {
            const modal = document.getElementById(id);
            if (show) {
                modal.classList.remove('opacity-0', 'pointer-events-none');
                document.body.classList.add('modal-active');
            } else {
                modal.classList.add('opacity-0', 'pointer-events-none');
                document.body.classList.remove('modal-active');
            }
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Fill settings
            document.getElementById('ghUsername').value = config.username;
            document.getElementById('ghRepo').value = config.repo;
            document.getElementById('ghClientId').value = config.clientId;

            await checkAuth();
            loadPages();

            // Settings
            document.getElementById('settingsBtn').onclick = () => toggleModal('settingsModal', true);
            document.getElementById('saveSettings').onclick = async () => {
                config.username = document.getElementById('ghUsername').value;
                config.repo = document.getElementById('ghRepo').value;
                config.clientId = document.getElementById('ghClientId').value;
                localStorage.setItem('ghUsername', config.username);
                localStorage.setItem('ghRepo', config.repo);
                localStorage.setItem('ghClientId', config.clientId);
                toggleModal('settingsModal', false);

                await checkAuth();
                loadPages();
            };

            // New Page
            document.getElementById('addPageBtn').onclick = () => {
                currentEditingFile = null;
                document.getElementById('modalTitle').innerText = 'New Page';
                document.getElementById('pageTitle').value = '';
                document.getElementById('pageCategory').value = '';
                document.getElementById('pageFilename').value = '';
                document.getElementById('pageFilename').disabled = false;
                document.getElementById('pageHtml').value = '';
                toggleModal('pageModal', true);
            };

            // Save Page
            document.getElementById('savePageBtn').onclick = async () => {
                const title = document.getElementById('pageTitle').value;
                const category = document.getElementById('pageCategory').value;
                const filename = document.getElementById('pageFilename').value;
                let html = document.getElementById('pageHtml').value;
                const btn = document.getElementById('savePageBtn');
                const status = document.getElementById('statusMsg');

                if (!title || !category || !filename || !html) {
                    alert('All fields are required');
                    return;
                }

                if (!config.token) {
                    alert('Please login with GitHub to save changes.');
                    return;
                }

                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-circle-notch animate-spin"></i> Saving...';
                status.innerText = '';

                try {
                    // 1. Inject home button
                    html = injectHomeButton(html);

                    // 2. Get current SHA if updating
                    let sha = null;
                    if (currentEditingFile) {
                        const fileData = await getFile(filename);
                        sha = fileData.sha;
                    }

                    // 3. Save HTML file
                    await saveFile(filename, html, `Update ${filename}`, sha);

                    // 4. Update metadata.json
                    const metaRes = await getFile('metadata.json');
                    let meta = metaRes ? JSON.parse(metaRes.content) : [];

                    const newEntry = {
                        filename,
                        title,
                        category,
                        date: new Date().toISOString().split('T')[0]
                    };

                    const existingIdx = meta.findIndex(p => p.filename === filename);
                    if (existingIdx > -1) {
                        meta[existingIdx] = newEntry;
                    } else {
                        meta.push(newEntry);
                    }

                    await saveFile('metadata.json', JSON.stringify(meta, null, 2), `Update metadata.json`, metaRes ? metaRes.sha : null);

                    status.className = 'text-xs font-medium text-emerald-500';
                    status.innerText = 'Success! Page saved.';
                    setTimeout(() => {
                        toggleModal('pageModal', false);
                        loadPages();
                    }, 1000);
                } catch (error) {
                    status.className = 'text-xs font-medium text-rose-500';
                    status.innerText = 'Error: ' + error.message;
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fa-solid fa-save"></i> Save Page';
                }
            };

            // Delete Page
            document.getElementById('confirmDeleteBtn').onclick = async () => {
                const btn = document.getElementById('confirmDeleteBtn');
                btn.disabled = true;
                btn.innerText = 'Deleting...';

                try {
                    // 1. Get file SHA
                    const fileData = await getFile(fileToDelete);
                    if (fileData) {
                        await deleteFile(fileToDelete, fileData.sha, `Delete ${fileToDelete}`);
                    }

                    // 2. Update metadata.json
                    const metaRes = await getFile('metadata.json');
                    if (metaRes) {
                        let meta = JSON.parse(metaRes.content);
                        meta = meta.filter(p => p.filename !== fileToDelete);
                        await saveFile('metadata.json', JSON.stringify(meta, null, 2), `Remove ${fileToDelete} from metadata`, metaRes.sha);
                    }

                    toggleModal('deleteModal', false);
                    loadPages();
                } catch (error) {
                    alert('Error deleting file: ' + error.message);
                } finally {
                    btn.disabled = false;
                    btn.innerText = 'Delete';
                }
            };

            // Search
            searchInput.oninput = () => {
                const activeCat = document.querySelector('.cat-filter.active').dataset.category;
                renderPages(activeCat, searchInput.value);
            };

            // Close Modals
            document.querySelectorAll('.closeModal').forEach(btn => {
                btn.onclick = () => {
                    toggleModal('settingsModal', false);
                    toggleModal('pageModal', false);
                    toggleModal('deleteModal', false);
                };
            });
        });
    </script>
</body>
</html>
